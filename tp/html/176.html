<!DOCTYPE HTML>
<html lang="zh-CN">
	<head>
		<meta charset="GB2312">
		<title>行为扩展</title>
		<link rel="stylesheet" href="../images/css/book.css">
		<link rel="stylesheet" href="../images/prettify/prettify.css">
		<script type="text/javascript" src="../images/js/jquery-1.10.2.min.js"></script>
		<script type="text/javascript" src="../images/prettify/prettify.js"></script>
		<script type="text/javascript">
			$(function(){	
				$(window).resize(function(){
					$('.book-content').css('min-height', $(window).height() - 130);
				}).resize();
				
				var $code = $(".book-content pre");
				$code.each(function(){
					var $this = $(this), $code = $this.children("code"), lang = $code.attr("class");
					$this.addClass("prettyprint linenums");
					lang && $this.addClass("lang-" + lang);					
				});
				
				//调用高亮插件，高亮代码
				prettyPrint();
				
				//解决表格存在边距的问题
				$("table").attr({"cellspacing":"0", "cellpadding":"0"});
				
				//快捷键翻页
				$(document).keydown(function(event){
					if(event.keyCode == 37){ //上一页
						$(".book-title .prev span").click();
					} else if(event.keyCode == 39) {//下一页
						$(".book-title .next span").click();
					}
				});
				
			});
		</script>
	</head>
	<body>
		<div class="book-title">
			<h1>行为扩展</h1>
            <div class="page"><a title="上一页" class="prev" href="175.html"><span>上一页</span></a><a title="下一页" class="next" href="177.html"><span>下一页</span></a></div>
            <div class="description"></div>
		</div>
		<div class="book-content"><p>行为（Behavior）是一个比较抽象的概念，你可以想象成在应用执行过程中的一个动作或者处理，在框架的执行流程中，各个位置都可以有行为产生，例如路由检测是一个行为，静态缓存是一个行为，用户权限检测也是行为，大到业务逻辑，小到浏览器检测、多语言检测等等都可以当做是一个行为，甚至说你希望给你的网站用户的第一次访问弹出Hello，world！这些都可以看成是一种行为，行为的存在让你无需改动框架和应用，而在外围通过扩展或者配置来改变或者增加一些功能。</p>

<p>而不同的行为之间也具有位置共同性，比如，有些行为的作用位置都是在应用执行前，有些行为都是在模板输出之后，我们把这些行为发生作用的位置称之为标签（位），当应用程序运行到这个标签的时候，就会被拦截下来，统一执行相关的行为，类似于AOP编程中的“切面”的概念，给某一个切面绑定相关行为就成了一种类AOP编程的思想。</p>

<p>系统核心提供的标签位置包括下面几个（按照执行顺序排列）：</p>

<pre><code>app_init    应用初始化标签位
path_info   PATH_INFO检测标签位
app_begin   应用开始标签位
action_name 操作方法名标签位
action_begin    控制器开始标签位
view_begin  视图输出开始标签位
view_parse  视图解析标签位
template_filter 模板内容解析标签位
view_filter 视图输出过滤标签位
view_end    视图输出结束标签位
action_end  控制器结束标签位
app_end         应用结束标签位
</code></pre>

<p>在每个标签位置，可以配置多个行为定义，行为的执行顺序按照定义的顺序依次执行。除非前面的行为里面中断执行了（某些行为可能需要中断执行，例如检测机器人或者非法执行行为），否则会继续下一个行为的执行。
行为定义：
通过Common\Conf\tags.php配置文件定义，格式如下：</p>

<pre><code>&lt;?php
return array(
    'action_begin'=&gt;array('Home\\Behaviors\\test','Home\\Behaviors\\test1'),//一个标签位可以有多个行为，使用数组即可。
    // 如果是3.2.1版本 则需要改成
    'action_begin'=&gt;array('Home\\Behaviors\\testBehavior','Home\\Behaviors\\test1Behavior')
);
</code></pre>

<p>上面注册了两个行为，分别是Home模块下的test和test1行为，类文件位于Home模块目录下的Behaviors目录，可以自定义目录。
行为必须是一个包含命名空间路径的类，如上的 Home&#92;Behaviors&#92;test 对应的类是  Home/Behaviors/test<strong>Behavior</strong>.class.php。</p>

<blockquote>
  <p>注意：注册行为的时候行为名不需要加Behavior后缀，但是创建类文件的时候需要在行为名test后面加上Behavior，以及类文件扩展名是.class.php。</p>
</blockquote>

<p>除了这些系统内置标签之外，开发人员还可以在应用中添加自己的应用标签。
比如在控制器的_initialize方法中：</p>

<pre><code>\Think\Hook::add('action_begin','Home\\Behaviors\\test1');//同时添加多个行为，只要将第二个参数换成数组即可。
// 3.2.1版本下面 需要改成
// \Think\Hook::add('action_begin','Home\\Behaviors\\test1Behavior');
</code></pre>

<p>行为类的定义,以上面的test行为为例：</p>

<pre><code>&lt;?php
namespace Home\Behaviors;
class testBehavior extends \Think\Behavior{
    //行为执行入口
    public function run(&amp;$param){

    }
}
</code></pre>

<p>行为类建议继承\Think\Behavior，必须实现run(&amp;$param)方法，行为是通过这个方法执行的。</p>

<p>行为的触发：
只要在合适的地方通过以下代码</p>

<pre><code>\Think\Hook::listen('标签名'[,参数]);
// 或者
// tag('标签名'[,参数]);
</code></pre>

<p>当应用执行到这个地方的时候将自动触发指定标签名下的所有行为类。</p>

<blockquote>
  <p>注意：动态注册的行为必须在Hook::listen之前，即：先注册行为，才能触发行为。</p>
  
  <p>listen方法可以传入并且只接受一个参数，如果需要传入多个参数，请使用数组，该参数为引用传值，所以只能传入变量。 参数可以被run(&amp;$param)中的$param接收。</p>
</blockquote>
</div>
		<div class="book-footer">
			<div class="page"><a title="上一页" class="prev" href="175.html"><span>上一页</span></a><a title="下一页" class="next" href="177.html"><span>下一页</span></a></div>
		</div>
	</body>
</html>
