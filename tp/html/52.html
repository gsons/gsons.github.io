<!DOCTYPE HTML>
<html lang="zh-CN">
	<head>
		<meta charset="GB2312">
		<title>连接数据库</title>
		<link rel="stylesheet" href="../images/css/book.css">
		<link rel="stylesheet" href="../images/prettify/prettify.css">
		<script type="text/javascript" src="../images/js/jquery-1.10.2.min.js"></script>
		<script type="text/javascript" src="../images/prettify/prettify.js"></script>
		<script type="text/javascript">
			$(function(){	
				$(window).resize(function(){
					$('.book-content').css('min-height', $(window).height() - 130);
				}).resize();
				
				var $code = $(".book-content pre");
				$code.each(function(){
					var $this = $(this), $code = $this.children("code"), lang = $code.attr("class");
					$this.addClass("prettyprint linenums");
					lang && $this.addClass("lang-" + lang);					
				});
				
				//调用高亮插件，高亮代码
				prettyPrint();
				
				//解决表格存在边距的问题
				$("table").attr({"cellspacing":"0", "cellpadding":"0"});
				
				//快捷键翻页
				$(document).keydown(function(event){
					if(event.keyCode == 37){ //上一页
						$(".book-title .prev span").click();
					} else if(event.keyCode == 39) {//下一页
						$(".book-title .next span").click();
					}
				});
				
			});
		</script>
	</head>
	<body>
		<div class="book-title">
			<h1>连接数据库</h1>
            <div class="page"><a title="上一页" class="prev" href="51.html"><span>上一页</span></a><a title="下一页" class="next" href="53.html"><span>下一页</span></a></div>
            <div class="description"></div>
		</div>
		<div class="book-content"><p>ThinkPHP内置了抽象数据库访问层，把不同的数据库操作封装起来，我们只需要使用公共的Db类进行操作，而无需针对不同的数据库写不同的代码和底层实现，Db类会自动调用相应的数据库驱动来处理。目前的数据库包括Mysql、SqlServer、PgSQL、Sqlite、Oracle、Ibase、Mongo，也包括对PDO的支持。</p>

<p>如果应用需要使用数据库，必须配置数据库连接信息，数据库的配置文件有多种定义方式。</p>

<h2>一、全局配置定义</h2>

<p>常用的配置方式是在应用配置文件或者模块配置文件中添加下面的配置参数：</p>

<pre><code>//数据库配置信息
'DB_TYPE'   =&gt; 'mysql', // 数据库类型
'DB_HOST'   =&gt; 'localhost', // 服务器地址
'DB_NAME'   =&gt; 'thinkphp', // 数据库名
'DB_USER'   =&gt; 'root', // 用户名
'DB_PWD'    =&gt; '123456', // 密码
'DB_PORT'   =&gt; 3306, // 端口
'DB_PREFIX' =&gt; 'think_', // 数据库表前缀 
'DB_CHARSET'=&gt; 'utf8', // 字符集
</code></pre>

<p>数据库的类型由<strong>DB_TYPE</strong>参数设置。</p>

<p>下面是目前支持的数据库设置：
<table>
<thead>
<tr>
  <th>DB_TYPE设置</th>
  <th>支持的数据库类型</th>
</tr>
</thead>
<tbody>
<tr>
  <td>mysql或mysqli</td>
  <td>mysql</td>
</tr>
<tr>
  <td>pgsql</td>
  <td>pgsql</td>
</tr>
<tr>
  <td>sqlite</td>
  <td>sqlite</td>
</tr>
<tr>
  <td>mssql 或sqlsrv</td>
  <td>sqlserver</td>
</tr>
<tr>
  <td>oracle</td>
  <td>oracle</td>
</tr>
<tr>
  <td>ibase</td>
  <td>ibase</td>
</tr>
<tr>
  <td>mongo</td>
  <td>mongo</td>
</tr>
<tr>
  <td>PDO</td>
  <td>PDO支持的所有数据库</td>
</tr>
</tbody>
</table></p>

<blockquote>
  <p>如果<strong>DB_TYPE</strong>使用<code>PDO</code>类型的话，数据库类型则由<strong>DB_DSN</strong>配置决定。</p>
</blockquote>

<p>或者采用如下配置</p>

<pre><code>'DB_DSN' =&gt; 'mysql://root:123456@localhost:3306/thinkphp#utf8'
</code></pre>

<p>使用DB_DSN方式定义可以简化配置参数，DSN参数格式为：</p>

<h5>数据库类型://用户名:密码@数据库地址:数据库端口/数据库名#字符集</h5>

<blockquote>
  <p>字符集设置需要3.2.1版本以上有效，字符集如果没有设置的话，默认为utf8。</p>
</blockquote>

<p>如果两种配置参数同时存在的话，<code>DB_DSN</code>配置参数优先。</p>

<blockquote>
  <p>注意：如果要设置分布式数据库，暂时不支持DB_DSN方式配置。</p>
</blockquote>

<p>如果采用PDO驱动的话，则必须首先配置**DB_TYPE **为<code>pdo</code>，然后还需要单独配置其他参数，例如：</p>

<pre><code>//PDO连接方式
'DB_TYPE'   =&gt; 'pdo', // 数据库类型
'DB_USER'   =&gt; 'root', // 用户名
'DB_PWD'    =&gt; '', // 密码
'DB_PREFIX' =&gt; 'think_', // 数据库表前缀 
'DB_DSN'    =&gt; 'mysql:host=localhost;dbname=thinkphp;charset=UTF-8'
</code></pre>

<blockquote>
  <p>注意：PDO方式的DB_DSN配置格式有所区别，根据不同的数据库类型设置有所不同，具体可以参考PHP手册。</p>
</blockquote>

<p>配置文件定义的数据库连接信息一般是系统默认采用的，因为一般一个应用的数据库访问配置是相同的。该方法系统在连接数据库的时候会自动获取，无需手动连接。</p>

<p>可以对每个模块定义不同的数据库连接信息，如果开启了调试模式的话，还可以在不同的应用状态的配置文件里面定义独立的数据库配置信息。</p>

<h2>二、模型类定义</h2>

<p>如果在某个模型类里面定义了<code>connection</code>属性的话，则实例化该自定义模型的时候会采用定义的数据库连接信息，而不是配置文件中设置的默认连接信息，通常用于某些数据表位于当前数据库连接之外的其它数据库，例如：</p>

<pre><code>//在模型里单独设置数据库连接信息
namespace Home\Model;
use Think\Model;
class UserModel extends Model{
    protected $connection = array(
        'db_type'  =&gt; 'mysql',
        'db_user'  =&gt; 'root',
        'db_pwd'   =&gt; '1234',
        'db_host'  =&gt; 'localhost',
        'db_port'  =&gt; '3306',
        'db_name'  =&gt; 'thinkphp',
        'db_charset' =&gt;    'utf8',
    );
}
</code></pre>

<p>也可以采用DSN方式定义，例如：</p>

<pre><code>//在模型里单独设置数据库连接信息
namespace Home\Model;
use Think\Model;
class UserModel extends Model{
    //或者使用DSN定义
    protected $connection = 'mysql://root:1234@localhost:3306/thinkphp#utf8';
}
</code></pre>

<p>如果我们已经在配置文件中配置了额外的数据库连接信息，例如：</p>

<pre><code>//数据库配置1
'DB_CONFIG1' =&gt; array(
    'db_type'  =&gt; 'mysql',
    'db_user'  =&gt; 'root',
    'db_pwd'   =&gt; '1234',
    'db_host'  =&gt; 'localhost',
    'db_port'  =&gt; '3306',
    'db_name'  =&gt; 'thinkphp',
    'db_charset'=&gt;    'utf8',
),
//数据库配置2
'DB_CONFIG2' =&gt; 'mysql://root:1234@localhost:3306/thinkphp#utf8';
</code></pre>

<p>那么，我们可以把模型类的属性定义改为：</p>

<pre><code>//在模型里单独设置数据库连接信息
namespace Home\Model;
use Think\Model;
class UserModel extends Model{
    //调用配置文件中的数据库配置1
    protected $connection = 'DB_CONFIG1';
}
</code></pre>

<pre><code>//在模型里单独设置数据库连接信息
namespace Home\Model;
use Think\Model;
class InfoModel extends Model{
    //调用配置文件中的数据库配置1
    protected $connection = 'DB_CONFIG2';
}
</code></pre>

<h2>三、实例化定义</h2>

<p>除了在模型定义的时候指定数据库连接信息外，我们还可以在实例化的时候指定数据库连接信息，例如：
如果采用的是M方法实例化模型的话，也可以支持传入不同的数据库连接信息，例如：</p>

<pre><code>$User = M('User','other_','mysql://root:1234@localhost/demo#utf8'); 
</code></pre>

<p>表示实例化User模型，连接的是demo数据库的other_user表，采用的连接信息是第三个参数配置的。如果我们在项目配置文件中已经配置了<code>DB_CONFIG2</code>的话，也可以采用：</p>

<pre><code>$User = M('User','other_','DB_CONFIG2'); 
</code></pre>

<blockquote>
  <p>需要注意的是，ThinkPHP的数据库连接的惰性的，所以并不是在实例化的时候就连接数据库，而是在有实际的数据操作的时候才会去连接数据库（额外的情况是，在系统第一次实例化模型的时候，会自动连接数据库获取相关模型类对应的数据表的字段信息）。</p>
</blockquote>
</div>
		<div class="book-footer">
			<div class="page"><a title="上一页" class="prev" href="51.html"><span>上一页</span></a><a title="下一页" class="next" href="53.html"><span>下一页</span></a></div>
		</div>
	</body>
</html>
