<extend name="Tpl:Base"/>
<block name="body">
    <!-- Main content -->
    <section class="content">

        <div class="box">
            <div class="box-header with-border">
                <h3 class="box-title">信件详情</h3>
            </div>
            <div class="box-body no-padding">
                <table class="table">
                    <tbody>
                    <tr>
                        <th width="10%;">信件主题</th>
                        <td colspan="3">{$info.title}</td>
                    </tr>
                    <tr>
                        <th width="10%;">信件类型</th>
                        <td width="40%;">{$info.type_id|get_field='LetterType','name'}</td>
                        <th width="10%;">当前状态</th>
                        <td width="40%;">{$status[$info[status]]}</td>
                    </tr>
                    <tr>
                        <th>信访部门</th>
                        <td>{$info.first_department_id|get_field='AuthGroup','title'}</td>
                        <th>受理编号</th>
                        <td>{$info.index_number}</td>
                    </tr>
                    <tr>
                        <th>受理部门</th>
                        <td>{$info.department_id|get_field='AuthGroup','title'}</td>
                        <th>写信人</th>
                        <td>{$info.name}</td>
                    </tr>
                    <tr><th>性 别</th>
                        <td>{: $info['sex'] ? '男' : '女'}</td>
                        <th>证件类型</th>
                        <td>{$info.certificate_name}</td>
                    </tr>
                    <tr><th>证件号码</th>
                        <td>{$info.identity_number}</td>
                        <th>职业</th>
                        <td>{$info.profession}</td>

                    </tr>
                    <tr><th>年龄</th>
                        <td>{$info.age}</td>
                        <th>联系电话</th>
                        <td>{$info.telphone}</td>

                    </tr>
                    <tr> <th>写信时间</th>
                        <td>{$info.datetime|date="Y-m-d H:i:s",###}</td>
                        <th>电子邮箱</th>
                        <td>{$info.email}</td>

                    </tr>
                    <tr><th>是否公开</th>
                        <td>{: $info['is_public'] ? '是' : '否'}  <?php if($_GET['show'] != 'false'):?> <a class="ajax-submit ajax-get ajax-del" data-href="{:U('Letter/setPublic',array('id'=>$info['id']))}">{: $info['is_public'] ? '隐藏' : '公开'}</a> <?php endif;?></td>
                        <th>联系地址</th>
                        <td>{$info.address}</td>

                    </tr>
                    <tr><th>上传附件</th>
                        <td>{: empty($info['accessory']) ? '没有附件' : '<a href="'.U('Download',array('fileName'=>base64_encode($info['accessory']))).'" target="_blank">下载附件</a>' } </td>
                        <th>IP地址</th>
                        <td colspan="3">{$info.ip|long2ip}</td>
                    </tr>
                    <tr>
                        <th>信件内容</th>
                        <td colspan="3">{$info.content}</td>
                    </tr>

                    </tbody>
                </table>
            </div>
        </div>
<?php if($_GET['show'] != 'false'):?>
        <div class="nav-tabs-custom">
            <div class="tab-content">
                <div class="tab-pane active" id="tab_1">
                    <?php if($info['status'] < 3):?>
                    <ul class="nav nav-tabs">
                        <?php if($info['status'] == 2):?>
                        <li class=""><a href="#dispose_3" data-toggle="tab" aria-expanded="false">已处理完</a></li>
                        <?php else:?>
                        <li class="active"><a href="#dispose_2" data-toggle="tab" aria-expanded="false">处理中</a></li>
                        <li><a href="#dispose_1" data-toggle="tab" aria-expanded="false">转交其他部门</a></li>
                        <?php endif;?>
                    </ul>
                    <div class="tab-content">
                        <?php if($info['status'] == 2):?>
                        <div class="tab-pane active" id="dispose_3">
                            <form action="__SELF__" id="post3">
                                <div class="box" style="border-top: 0px;">
                                    <div class="box-body">
                                        <div class="form-group">
                                            <label>处理结果 <span class="text-red">*</span></label>
                                            <script name="result" id="details" type="text/plain" style="height:300px;">
                                            </script>
                                        </div>
                                        <br>

                                        <div class="form-group">
                                            <label>公开状态：</label>
                                            <label class="checkbox-inline">
                                                <input type="radio" name="public" value="1" <neq name="info.public" value="0">checked</neq>  /> 公开
                                            </label>
                                            <label class="checkbox-inline">
                                                <input type="radio" name="public" value="0" <eq name="info.public" value="0">checked</eq> /> 隐藏 &nbsp;
                                            </label>
                                        </div>
                                        <br>

                                        <div class="form-group">
                                            <label>备注</label>
                                            <input type="text" class="form-control" name="remark" value="">
                                        </div>
                                        <br>
                                    </div><!-- /.box-body -->
                                    <div class="box-footer">
                                        <button type="button" class="btn btn-primary ajax-submit ajax-post" data-form="post3">提交</button>
                                    </div>
                                </div>
                                <input type="hidden" name="status" value="3">
                            </form>
                        </div>
                        <?php else:?>
                        <div class="tab-pane" id="dispose_1">
                            <form action="__SELF__" id="post1">
                                <div class="box" style="border-top: 0px;">
                                    <div class="box-body">
                                        <div class="form-group">
                                            <label>转交其他部门：<span class="text-red">*</span></label>
                                            <select name="turn_over_department_id" class="form-control select2 select2-hidden-accessible"
                                                    style="width: 100%;" tabindex="-1" aria-hidden="true">
                                                <option value="">请选择部门</option>
                                                <volist name="group" id="vo">
                                                    <option value="{$vo.id}">{$vo.title}</option>
                                                </volist>
                                            </select>
                                        </div>
                                        <br>
                                        <div class="form-group">
                                            <label>要求办结日期 <span class="text-red">*</span></label>
                                            <input type="text" class="form-control date" name="target_time" value="{$target_time|date='Y-m-d',###}">
                                        </div>
                                        <br>
                                        <div class="form-group">
                                            <label>备注</label>
                                            <input type="text" class="form-control" name="remark" value="请在7个工作日处理">
                                        </div>
                                        <br>
                                    </div><!-- /.box-body -->
                                    <input type="hidden" name="status" value="1">
                                    <div class="box-footer">
                                        <button type="button" class="btn btn-primary ajax-submit ajax-post" data-form="post1">提交</button>
                                        <a class="btn btn-danger ajax-submit ajax-get ajax-del" data-form="form" data-href="{:U('del',array('letter'=>1,'id'=>$info['id']))}">删除</a>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="tab-pane active" id="dispose_2">
                            <form action="__SELF__" id="post2">
                                <div class="box" style="border-top: 0px;">
                                    <div class="box-body">
                                        <div class="form-group">
                                            <label>备注</label>
                                            <input type="text" class="form-control" name="remark" value="">
                                        </div>
                                        <br>
                                    </div><!-- /.box-body -->
                                    <input type="hidden" name="status" value="2">
                                    <div class="box-footer">
                                        <button type="button" class="btn btn-primary ajax-submit ajax-post" data-form="post2">提交</button>
                                        <a class="btn btn-danger ajax-submit ajax-get ajax-del" data-form="form" data-href="{:U('del',array('letter'=>1,'id'=>$info['id']))}">删除</a>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <?php endif;?>
                    </div>
                    <?php else: ?>
                    <div class="tab-pane" id="dispose_3">
                        <form action="__SELF__" id="post3">
                            <div class="box" style="border-top: 0px;">
                                <div class="box-body">
                                    <div class="form-group">
                                        <label>处理结果</label>
                                        <script name="result" id="details" type="text/plain" style="height:300px;">
                                        {$last_history.result|htmlspecialchars_decode}
                                        </script>
                                    </div>
                                    <br>
                                    <div class="form-group">
                                        <label>备注</label>
                                        <input type="text" class="form-control" name="remark" value="{$last_history.remark}">
                                    </div>
                                    <br>

                                </div><!-- /.box-body -->
                                <input type="hidden" name="status" value="3">
                                <div class="box-footer">
                                    <button type="button" class="btn btn-primary ajax-submit ajax-post" data-form="post3">提交</button>
                                    <a class="btn btn-danger ajax-submit ajax-get ajax-del" data-form="form" data-href="{:U('del',array('letter'=>1,'letter'=>'1','id'=>$info['id']))}">删除</a>
                                </div>
                            </div>
                        </form>
                    </div>

                    <?php endif; ?>
                </div><!-- /.tab-pane -->
            </div><!-- /.tab-content -->
        </div>

        <?php if(!empty($info['history'])) : ?>
        <div class="nav-tabs-custom">
            <div class="tab-content">
                <div class="tab-pane active" id="tab_2">
                    <div class="box box-success">
                        <div class="box-body no-padding">
                            <table class="table table-striped">
                                <tbody>
                                <tr>
                                    <th width="15%">部门</th><th width="15%">信件状态</th><th width="15%">受理时间</th><th width="15%">要求办结时间</th><th width="15%">操作者</th><th>备注</th>
                                </tr>
                                <volist name="info.history" id="vo">
                                    <tr>
                                        <td>{$vo.department_id|get_field='AuthGroup','title'}</td>
                                        <td>{$status[$vo[status]]}</td>
                                        <td>{$vo.update_time|date="Y-m-d H:i:s",###}</td>
                                        <td>{: $vo['status'] == 3 ? '---------------' : date("Y-m-d",$vo['target_time'] )}</td>
                                        <td>{$vo.admin_name}</td>
                                        <td>{$vo.remark}</td>
                                    </tr>
                                </volist>
                            </tbody></table>
                        </div>
                    </div>
                </div><!-- /.tab-pane -->
            </div><!-- /.tab-content -->
        </div>
        <?php endif; ?>

    <div class="box">
            <div class="box-header">
                <h3 class="box-title iframe-title">信件评论</h3>
                <div class="btn-toolbar">
                        <a class="btn btn-danger ajax-submit ajax-post ajax-del" data-form="form" data-href="{:U('del')}">删除</a>
                    </div>
                <form action="" method="get" id="search_form">
                    <div class="search">
                    <?php /* ?>
                        <select name="type" class="form-control select2 select2-hidden-accessible" style="width: 100%;" tabindex="-1" aria-hidden="true">
                            <option value="">请选择</option>
                        </select>
                    <?php */ ?>
                        <input type="text" name="keyword" class="form-control" value="{:I('get.keyword')}">
                        <input type="submit" value="搜索" class="btn btn-info">
                    </div>
                </form>
            </div><!-- /.box-header -->
            <div class="box-body no-padding">
            <form action="" method="post" id="form">
                <table class="table table-striped">
                    <tbody>
                    <tr>
                        <th><input type="checkbox" data-check="check-all" data-name="ids[]"/><th  style="width: 100px;">编号</th><th>操作</th><th>信件主题</th><th>评论内容</th><th>用户名</th><th>状态</th><th>评论日期</th><th>IP</th>
                    </tr>
                    <volist name="list" id="vo">
                        <tr>
                        <td><input type="checkbox" name="ids[]" value="{$vo.id}"/></td>
                            <td width="5%">{$vo.id}</td>
                            <td width="10%">
                                <!--<a href="{:U('Article/ArticleDetail',array('id'=>$vo['id']))}">查看</a>-->
                            <a class="ajax-submit ajax-get ajax-del" data-href="{:U('comment',array('id'=>$vo['id'],'status'=>($vo['status']==1?0:1)))}">{:$vo['status'] == 1 ? '取消审核' : '通过审核'}</a>
                            </td>
                            <td width="15%" title="{$vo.title}"><a target="_blank" href="{:modelUrl(U('Interact/detail',array('id'=>$vo['letter_id'])),'index')}">{$vo.title|msubstr=0,15}</a></td>
                            <td width="" title="{$vo.comment_content}">{$vo.comment_content|msubstr=0,30}</td>
                            <td width="10%" title="{$vo.observer}">{$vo.observer|msubstr=0,8}</td>
                            <td width="10%">{: $vo[status] ==  1? '已通过审核' : '未通过审核'}</td>
                            <td width="10%">{$vo.datetime|FormatDate}</td>
                            <td width="10%">{$vo.ip_address}</td>

                        </tr>
                    </volist>
                    </tbody></table>
                    </form>
            </div><!-- /.box-body -->
            <div class="box-footer">
                {$page}
            </div>
        </div>


<?php endif;?>

    </section>
    <!-- /.content -->

</block>
<block name="script">
    <script src="__PLUS__/ueditor/ueditor.config.js"></script>
    <script src="__PLUS__/ueditor/ueditor.all.min.js"></script>
    <script src="__PLUS__/ueditor/ueditor.parse.min.js"></script>
    <script>

        var ue = UE.getEditor('details', {
            toolbars: [[
                'undo', 'redo', '|',
                'bold', 'italic', 'underline', 'fontborder', 'strikethrough', 'superscript', 'subscript', 'removeformat', 'formatmatch', 'autotypeset', 'blockquote', 'pasteplain', '|', 'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'selectall', 'cleardoc', '|',
                'rowspacingtop', 'rowspacingbottom', 'lineheight', '|',
                'fontfamily', 'fontsize', '|',
                'directionalityltr', 'directionalityrtl', 'indent', '|',
                'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify', '|', 'touppercase', 'tolowercase', '|',
                'link', 'unlink', 'anchor', '|', 'imagenone', 'imageleft', 'imageright', 'imagecenter', '|',
                'simpleupload', 'insertimage','insertvideo', 'map', 'gmap', '|',
                'horizontal', 'date', 'time', 'spechars', 'snapscreen', 'wordimage', '|',
                'inserttable', 'deletetable', 'insertparagraphbeforetable', 'insertrow', 'deleterow', 'insertcol', 'deletecol', 'mergecells', 'mergeright', 'mergedown', 'splittocells', 'splittorows', 'splittocols', 'charts', '|',
                'drafts'
            ]]
        });
    </script>

    <script src="__PLUS__/uploadify/jquery.uploadify.min.js"></script>
    <link rel="stylesheet" href="__PLUS__/uploadify/uploadify.css"/>
    <script>
        var auid = '{:is_admin()}';
        $('#pic_upload').uploadify({
            'multi': true,
            'fileTypeExts': '*.gif; *.jpg; *.png',
            'formData': {'auid': auid},
            'buttonText': '上传',
            'swf': '__PLUS__/uploadify/uploadify.swf',
            'uploader': '{:U("Public/UploadFile",array("type"=>"image"))}',
            'height': 35,
            'width': 70,
            'onUploadSuccess': function (file, data, response) {
                var data = JSON.parse(data);
                if (data.status == '1') {
                    var picker = '<img style="max-width:100%;" src="__UPLOAD__/' + data.info.Filedata.savepath + '' + data.info.Filedata.savename + '" alt=""/> <input type="hidden" name="src" value="' + data.info.Filedata.savepath + '' + data.info.Filedata.savename + '" /> ';
                    $('#queue').html(picker);
                } else if (data.status == '0') {
                    layer.msg(data.info)
                } else {
                    layer.msg(data)
                }
            }
        });

        $('#video_upload').uploadify({
            'multi': true,
            'fileTypeExts': '*.mp4; *.wmv *.flv',
            'formData': {'auid': auid},
            'buttonText': '上传',
            'swf': '__PLUS__/uploadify/uploadify.swf',
            'uploader': '{:U("Public/UploadFile",array("type"=>"video"))}',
            'height': 35,
            'width': 70,
            'onUploadSuccess': function (file, data, response) {
                var data = JSON.parse(data);
                if (data.status == '1') {
                    var src = data.info.Filedata.savepath + '' + data.info.Filedata.savename;
                    $('input[name=video_src]').val(src);
                    $('input[name=video_name]').val(data.info.Filedata.name);
                } else if (data.status == '0') {
                    layer.msg(data.info)
                } else {
                    layer.msg(data)
                }
            }
        });

    </script>

</block>