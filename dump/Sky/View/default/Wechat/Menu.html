<extend name="Tpl:Base" />
<block name="body">
    <!-- Main content -->
    <section class="content">
        <div class="box">
            <div class="box-header with-border">
                <h3 class="box-title iframe-title">自定义菜单</h3>
            </div><!-- /.box-header -->
            <div class="box-body">
                <div class="container-fluid we-menu">
                    <notempty name="info">
                        <PHP>$sub_menu_number = 1;</PHP>
                        <volist name="info" id="vo" key="i">
                            <ul class="menu-item">
                                <li class="form-inline parent-menu">
                                    <div class="form-group">
                                        <label class="sr-only">请输入该菜单的名称</label>
                                        <input type="text" class="form-control" id="parent-menu-{$i}" {$vo.attr} data-level="0" placeholder="请输入该菜单的名称" value="{$vo.name}">
                                        <notempty name="vo.sub_button">
                                            <div class="movement green"><i class="fa fa-fw fa-minus-circle"></i> 触发二级菜单</div>
                                            <else />
                                            <div class="movement green">
                                                <eq name="vo.type" value="click">
                                                    <i class="fa fa-fw fa-dot-circle-o"></i> 触发关键字：{$vo.key}
                                                </eq>
                                                <eq name="vo.type" value="view">
                                                    <i class="fa fa-fw fa-link"></i> 链接跳转：<a href="{$vo.url}" title="{$vo.url}">{$vo.url|msubstr=0,40}</a>
                                                </eq>
                                            </div>
                                        </notempty>
                                    </div>
                                    <div class="btn-group">
                                        <a class="btn btn-primary" data-toggle="modal" data-target="#myModal" onclick="outMovement(this)">设置动作</a>
                                        <a class="btn btn-info add-sub-menu">添加子菜单</a>
                                        <neq name="i" value="1">
                                            <a class="btn btn-danger" onclick="removeParentMenu(this)">删除此菜单</a>
                                        </neq>
                                    </div>
                                </li>
                                <ul class="child-menu-item">
                                    <volist name="vo.sub_button" id="item" key="t">
                                        <li class="form-inline sub-menu">
                                            <div class="form-group">
                                                <label class="sr-only">请输入该菜单的名称</label>
                                                <input type="text" class="form-control" id="sub-menu-{$sub_menu_number}" {$item.attr} data-level="1"  placeholder="请输入该菜单的名称" value="{$item.name}" >
                                                <div class="movement green">
                                                    <eq name="item.type" value="click">
                                                        <i class="fa fa-fw fa-dot-circle-o"></i> 触发关键字：{$item.key}
                                                    </eq>
                                                    <eq name="item.type" value="view">
                                                        <i class="fa fa-fw fa-link"></i> 链接跳转：<a href="{$item.url}" title="{$item.url}">{$item.url|msubstr=0,40}</a>
                                                    </eq>
                                                </div>
                                            </div>
                                            <div class="btn-group">
                                                <a class="btn btn-primary" data-toggle="modal" data-target="#myModal" onclick="outMovement(this)">设置动作</a>
                                                <a class="btn btn-default" onclick="removeMenu(this)">删除此菜单</a>
                                            </div>
                                        </li>
                                        <PHP>$sub_menu_number++;</PHP>
                                    </volist>
                                </ul>
                            </ul>
                            <hr/>
                        </volist>

                        <else />
                        <ul class="menu-item">
                            <li class="form-inline parent-menu">
                                <div class="form-group">
                                    <label class="sr-only">请输入该菜单的名称</label>
                                    <input type="text" class="form-control" id="parent-menu-1" data-level="0" placeholder="请输入该菜单的名称">
                                    <div class="movement red"><i class="fa fa-fw fa-minus-circle"></i> 请选择动作</div>
                                </div>
                                <div class="btn-group">
                                    <a class="btn btn-primary" data-toggle="modal" data-target="#myModal" onclick="outMovement(this)">设置动作</a>
                                    <a class="btn btn-info add-sub-menu">添加子菜单</a>
                                </div>
                            </li>
                            <ul class="child-menu-item">

                            </ul>
                        </ul>
                        <hr/>
                    </notempty>
                </div>
            </div><!-- /.box-body -->
            <div class="box-footer">
                <div class="btn-group" style="margin-left:52px;">
                    <button class="btn btn-success" onclick="submitMenu()" >提交</button>
                    <button class="btn btn-primary add-parent-btn" >增加一级菜单</button>
                </div>
            </div>
        </div>
    </section><!-- /.content -->

    <div class="modal fade we-menu-modal" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                    <h4 class="modal-title">设置动作</h4>
                </div>
                <div class="modal-body">
                    <div class="nav-tabs-custom">
                        <ul class="nav nav-tabs">
                            <li class="active"><a href="#view" data-toggle="tab">链接跳转</a></li>
                            <li><a href="#click" data-toggle="tab">关键字</a></li>
                            <!--<li><a href="#tab_3" data-toggle="tab">地理位置</a></li>-->
                        </ul>
                        <div class="tab-content">
                            <div class="tab-pane active" id="view">
                                <div class="form-group">
                                    <input type="text" class="form-control" placeholder="请输入跳转的链接" value="http://"/>
                                    <label>将菜单动作设置为链接后，点击菜单将会使用微信内置的浏览器跳转到所输入的网址，输入的网址格式必须完成。例：http://www.simplexun.com。</label>
                                </div>
                            </div><!-- /.tab-pane -->
                            <div class="tab-pane" id="click">
                                <div class="form-group">
                                    <input type="text" class="form-control" placeholder="请输入所要触发的关键字" />
                                    <label> 将菜单动作设置为关键字后，点击菜单将会自动触发所输入的关键字。</label>
                                </div>
                            </div><!-- /.tab-pane -->
                        </div><!-- /.tab-content -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default pull-left" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-success" onclick="setMovement(this)">确定</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div>
</block>
<block name="script">
    <script>

        $(document).on('click','.add-sub-menu',function(){
            var line = $(this).parent().parent().next();
            var sub_nums = $(line).children('.sub-menu').length
            if( sub_nums > 4){
                layer.msg('每个顶级菜单下最多5个子菜单');
                return false;
            }

            if( sub_nums > -1 ){
                resetMovement(this);
                $(this).parent().parent().attr('data-sub',1)
            }

            var lid = 0;
            $.each($('.sub-menu'),function(){
                var $_t = $(this).children().find('.form-control').attr('id').match(/\d+/g);
                if( parseInt(lid) < parseInt($_t) ){
                    lid = $_t;
                }
            })
            lid++ ;

            var sub = '<li class="form-inline sub-menu"> ' +
                    '<div class="form-group"> ' +
                    '<label class="sr-only">请输入该菜单的名称</label> ' +
                    '<input type="text" class="form-control" id="sub-menu-'+lid+'" data-level="1"  placeholder="请输入该菜单的名称">' +
                    '<div class="movement red"><i class="fa fa-fw fa-minus-circle"></i> 请选择动作</div> ' +
                    '</div> ' +
                    '<div class="btn-group"> ' +
                    '<a class="btn btn-primary" data-toggle="modal" data-target="#myModal" onclick="outMovement(this)">设置动作</a> ' +
                    '<a class="btn btn-default" onclick="removeMenu(this)">删除此菜单</a> ' +
                    '</div> ' +
                    '</li>';
            $(this).parent().parent().next().prepend(sub);
        })

        $('.add-parent-btn').click(function(){
            var par_nums = $('.we-menu .menu-item').length
            if( par_nums > 2 ){
                layer.msg('顶级菜单最多添加3个')
                return false;
            }

            var lastid = $('.we-menu .menu-item').last().children().eq(0).find('.form-control').attr('id');
            if(lastid!=undefined) {
                var patt1 = new RegExp("[0-9]");
                var lid = parseInt(patt1.exec(lastid));
                lid++;
            }else{
                lid = 0;
            }

            var $pli = '<ul class="menu-item"> ' +
                    '<li class="form-inline parent-menu"> ' +
                    '<div class="form-group"> ' +
                    '<label class="sr-only">请输入该菜单的名称</label> ' +
                    '<input type="text" class="form-control" id="parent-menu-'+(lid)+'" data-level="0" placeholder="请输入该菜单的名称"> ' +
                    '<div class="movement red"><i class="fa fa-fw fa-minus-circle"></i> 请选择动作</div> ' +
                    '</div> ' +
                    '<div class="btn-group"> ' +
                    '<a class="btn btn-primary" data-toggle="modal" data-target="#myModal" onclick="outMovement(this)">设置动作</a> ' +
                    '<a class="btn btn-info add-sub-menu">添加子菜单</a> ' +
                    '<a class="btn btn-danger" onclick="removeParentMenu(this)">删除此菜单</a> ' +
                    '</div> ' +
                    '</li> ' +
                    '<ul class="child-menu-item"></ul>' +
                    '</ul>' +
                    ' <hr/>';

            $('.we-menu').append($pli);
        })

        function resetMovement(obj){
            var input = $(obj).parent().prev().children().eq(1)
            var movement = $(obj).parent().prev().children().eq(2)
            var original = '<div class="movement green"><i class="fa fa-fw fa-minus-circle"></i> 触发二级菜单</div>';
            input.removeAttr('key')
            input.removeAttr('url')
            movement.remove();
            $(obj).parent().prev().append(original);
            $(obj).prev().addClass('disabled')
            $(obj).prev().attr('disabled','')
        }

        var now_input = '';
        function outMovement(obj){
            now_input = $(obj).parent().prev().find('.form-control').attr('id');
            console.log($(obj).parent().prev().find('.form-control'));
        }

        function setMovement(obj){
            var attr = new Array('data-type','key','url');

            var active =  $('#myModal .nav-tabs').find('.active');
            var id = active.children().eq(0).attr('href')

            var data = new Array();
            var movement = '';
            var tip = '';
            data['data-type'] = $(id).attr('id');
            switch ( data['data-type'] ){
                case 'click':
                    data['key'] = $(id).find('.form-control').val();
                    movement = 'fa fa-fw fa-dot-circle-o';
                    tip = '触发关键字：'+ data['key']
                    break;
                case 'view':
                    data['url'] = $(id).find('.form-control').val();
                    movement = 'fa fa-fw fa-link'
                    tip = '链接跳转：<a href="'+data['url']+'" title="'+data['url']+'">'+ data['url'].substr(0,40) + '...</a>'
                    break;
            }
            console.log(tip);
            for(var i in attr){
                $('#'+now_input).removeAttr(attr[i]);
            }
            for(var key in data){
                $('#'+now_input).attr(key,data[key]);
                $('#'+now_input).next().removeClass('red').addClass('green')
                $('#'+now_input).next().html('<i class="'+movement+'"></i>'+tip);
            }
            $('#myModal').modal('hide')
        }

        function removeMenu(obj){
            var parent_menu = $(obj).parent().parent().parent().prev();
            if( parent_menu.next().children('.sub-menu').length == 1 ){
                parent_menu.removeAttr('data-sub');
                parent_menu.children().eq(0).find('.movement').remove();
                parent_menu.children().eq(0).append('<div class="movement red"><i class="fa fa-fw fa-minus-circle"></i> 请选择动作</div>')
                parent_menu.children().eq(1).children().eq(0).removeClass('disabled').removeAttr('disabled')
            }
            $(obj).parent().parent().remove();
        }

        function removeParentMenu(obj){
            $(obj).parent().parent().parent().next().remove();
            $(obj).parent().parent().parent().remove();
        }

        function submitMenu(){
            var MenuData = new Array();
            var Lastdata = new Array();
            var _data = new Object();
            var lis = $('.menu-item');
            var _tmp = new Array();
            var _t = new Object();
            var p = 0;
            for(var i = 0; i < lis.length ; i++ ){
                $.each($(lis[i]).find('.form-control'),function(){
                    var is_sub = $(this).attr('data-sub')
                    var level = $(this).attr('data-level');
                    _data.type = $(this).attr('data-type')
                    _data.name = $(this).val();
                    switch ( _data.type ){
                        case 'click':
                            _data.key = $(this).attr('key')
                            break;
                        case 'view':
                            _data.url = $(this).attr('url')
                            break;
                    }
                    if ( is_sub=='0' ) {
                        MenuData = _data;
                    } else {
                        if( level == 0 ){
                            MenuData = _data;
                            _data = new Object();
                        }else{
                            _tmp[p] = _data;
                            _data = new Object();
                            p++;
                        }
                    }
                })
                p = 0 ;
                MenuData['sub_button'] = _tmp;
                _tmp = new Array();
                Lastdata[i] = MenuData;
            }
            _t.button = Lastdata
            $.ajax({
                url: '{:U("")}',
                data: _t,
                type: 'post',
                dataType: 'json',
                beforeSend:loading(),
                success: function (data) {
                    if (data.status == '1') {
                        layer.msg(data.info,{icon:1,time:2000},function(){
                            //TODO
                        })
                    } else if (data.status == '0') {
                        layer.msg(data.info)
                    } else {
                        layer.msg(data)
                    }
                    loaded();
                },
                error: function () {
                    layer.msg('系统错误，请稍后再试');
                    loaded();
                }
            })
        }

    </script>
</block>