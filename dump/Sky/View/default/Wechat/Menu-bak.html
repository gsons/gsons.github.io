<extend name="Tpl:Base" />
<block name="body">
    <div id="Wemenu" class="iframe-content">
        <div class="topic">
            自定义菜单
        </div>
        <form action="">
            <ul class="wemenu">
                <li>
                    <div class="parent-menu">
                        <input type="text" class="input" placeholder="请输入该菜单的名称" id="parent-menu-1" data-level="0"/>
                        <a href="javascript:" onclick="outMonvement(this)">设置此菜单动作</a>
                        <!--<a href="javascript:">删除此菜单</a>-->
                        <a href="javascript:" class="add-sub-menu alertmsg" alertmsg="子菜单最多5个">添加子菜单</a>
                    </div>
                </li>
            </ul>
            <div class="btngroup">
                <a href="javascript:" class="btn btn-info add-parent-btn alertmsg" alertmsg="顶级菜单最多3个">添加一级菜单</a>
                <a href="javascript:" class="btn btn-info">历史菜单</a>
            </div>
            <div class="btngroup">
                <a href="javascript:" class="btn btn-success" onclick="submitMenu()" >提交</a>
            </div>
        </form>

        <div id="Setmenu" class="hide">
            <div class="topic">
                设置菜单属性
            </div>
            <div class="radio-group">
                <div class="radio-control">
                    <input type="radio" data-role="click" name="key" checked/>
                    <label>关键字</label>
                </div>
                <div class="radio-control">
                    <input type="radio" data-role="view" name="key"/>
                    <label>链接</label>
                </div>
                <div class="clear"></div>
            </div>
            <div class="setvalue-group">
                <div class="setvalue-click">
                    <input type="text" class="input" placeholder="请输入所要触发的关键字" checked />
                    <p>
                        将菜单动作设置为关键字后，点击菜单将会自动触发所输入的关键字。
                    </p>
                </div>
                <div class="setvalue-view hide">
                    <input type="text" class="input" placeholder="请输入跳转的链接" value="http://"/>
                    <p>
                        将菜单动作设置为链接后，点击菜单将会使用微信内置的浏览器跳转到所输入的网址，输入的网址格式必须完成。例：http://www.simplexun.com。
                    </p>
                </div>
            </div>
            <div class="confirm-group">
                <a href="javascript:" class="btn btn-info close-panel" onclick="setMovement(this)">确定</a>
                <a href="javascript:" class="btn btn-warning close-panel" onclick="clearMovement()">取消</a>
            </div>
        </div>
    </div>
</block>
<block name="script">
    <script>
        $('.add-sub-menu').on('click',function(){
            var line = $(this).parent().parent();
            var sub_nums = $(line).children('.sub-menu').length
            if( sub_nums > 4){
//                Alert_msg_box.alert($(this));
                return false;
            }

            if( sub_nums > -1 ){
                $(this).parent().parent().children().eq(0).children().eq(0).attr('data-sub',1)
            }

            var lastid = $('.sub-menu').last().children().eq(0).attr('id');
            console.log(lastid);
            if(lastid!=undefined) {
                var lid = lastid.match(/\d+/g);
                lid++;
            }else{
                lid = 0;
            }

            var sub = '<div class="sub-menu"> ' +
                    '┗━━━━ <input type="text" class="input" placeholder="请输入该菜单的名称" id="sub-menu-'+lid+'" data-level="1" /> ' +
                    '<a href="javascript:" onclick="outMonvement(this)">设置此菜单动作</a> ' +
                    '<a href="javascript:" onclick="removeMenu(this)">删除此菜单</a> ' +
                    '</div>';
            $(this).parent().parent().append(sub);
        })

        $('.add-parent-btn').click(function(){
            var par_nums = $('.wemenu').children('li').length
            if( par_nums > 2 ){
                Alert_msg_box.alert($(this));
                return false;
            }

            var lastid = $('.wemenu').children('li').last().children().eq(0).children().eq(0).attr('id');
            if(lastid!=undefined) {
                var patt1 = new RegExp("[0-9]");
                var lid = parseInt(patt1.exec(lastid));
                lid++;
            }else{
                lid = 0;
            }

            var $pli = '<li> ' +
                    '<div class="parent-menu"> ' +
                    '<input type="text" class="input" placeholder="请输入该菜单的名称" id="parent-menu-'+(lid)+'" data-level="0"/> ' +
                    '<a href="javascript:" onclick="outMonvement(this)">设置此菜单动作</a> ' +
                    '<a href="javascript:" onclick="removeParentMenu(this)">删除此菜单</a> ' +
                    '<a href="javascript:" class="add-sub-menu alertmsg" alertmsg="子菜单最多5个">添加子菜单</a> ' +
                    '</div> ' +
                    '</li>';

            $('.wemenu').append($pli);
        })

        $('.radio-control input').click(function(){
            var role = $(this).attr('data-role');
            $('.setvalue-group').children('.setvalue-'+role).show().siblings().hide();
        })

        $(document).on($('.btn-danger'),'click',(function(){
            $(this).parent().parent().remove();
        }))

        $('#ajaxsubmit').click(function () {

        })

        //封装操作函数
        //设置动作函数
        function outMonvement(obj){
            AlertBox('#Setmenu');
            var tid = $(obj).prev().attr('id');
            $('#Setmenu').attr('data-role',tid);
        }

        function setMovement(obj){

            if(!$('input[name=key]').val()){
                AlertTitle('请选择动作的类型');
                return false;
            }

            var data = new Array();
            data['data-type'] = $('#Setmenu input:checked').attr('data-role');
            switch ( data['data-type'] ){
                case 'click':
                    data['key'] = $('.setvalue-'+data['data-type']).children().eq(0).val();
                    break;
                case 'view':
                    data['url'] = $('.setvalue-'+data['data-type']).children().eq(0).val();
                    break;
            }


            var tid = $(obj).parent().parent().attr('data-role');

            for(var key in data){
                $('#'+tid).attr(key,data[key]);
            }

            $('#Setmnu').removeAttr('data-role');
            clearMovement()

        }

        function clearMovement(){
            $('#Setmenu input[type=radio]').eq(0).attr('checked','')
            $.each( $('#Setmenu .setvalue-group').children(),function(){
                $(this).children().eq(0).val('')
            })
            $('#Setmenu .setvalue-group').children().eq(0).show().siblings().hide();
        }

        function submitMenu(){
            var MenuData = new Array();
            var Lastdata = new Array();
            var _data = new Object();
            var lis = $('.wemenu li');
            var _tmp = new Array();
            var _t = new Object();
            var p = 0;
            for(var i = 0; i < lis.length ; i++ ){
                $.each($(lis[i]).find('.input'),function(){
                    var is_sub = $(this).attr('data-sub')
                    var level = $(this).attr('data-level');
                    _data.type = $(this).attr('data-type')
                    _data.name = $(this).val();
                    switch ( _data.type ){
                        case 'click':
                            _data.key = $(this).attr('key')
                            break;
                        case 'view':
                            _data.url = $(this).attr('url')
                            break;
                    }
                    if ( is_sub=='0' ) {
                        MenuData = _data;
                    } else {
                        if( level == 0 ){
                            MenuData = _data;
                            _data = new Object();
                        }else{
                            _tmp[p] = _data;
                            _data = new Object();
                            p++;
                        }
                    }
                })
                p = 0 ;
                MenuData['sub_button'] = _tmp;
                _tmp = new Array();
                Lastdata[i] = MenuData;
            }
            _t.button = Lastdata

            $.ajax({
                url:"{:U('Wemenu')}?wid={$wid}",
                data:_t,
                type:'post',
                success:function(data){
                    console.log(data)
                }
            })
        }

        function removeMenu(obj){

            if($(obj).parent().parent().children('.sub-menu').length == 1 ){
                $(obj).parent().parent().children().eq(0).children().eq(0).removeAttr('data-sub');
            }
            $(obj).parent().remove();

        }

        function removeParentMenu(obj){
            $(obj).parent().parent().remove();
        }

    </script>
</block>