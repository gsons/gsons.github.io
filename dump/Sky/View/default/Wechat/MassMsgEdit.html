<extend name="Tpl:Base"/>
<block name="body">
    <!-- Main content -->
    <section class="content">
        <a href="#" class="ion-reply history-back" onclick="history.back(1)">&nbsp;返回</a>
        <div class="nav-tabs-custom">
            <form action="" id="form">
                <div class="box box-success">
                    <div class="box-header with-border">
                        <h3 class="box-title">群发消息</h3>
                    </div>
                    <div class="box-body">
                        <div class="form-group">
                            <label>发送对象：</label>
                            <div>
                                <input type="radio" name="type" value="0" checked /> <label>全部</label>&nbsp;&nbsp;&nbsp;
                                <input type="radio" name="type" value="1" /> <label>分组</label>&nbsp;&nbsp;&nbsp;
                                <input type="radio" name="type" value="2" /> <label>用户</label>&nbsp;&nbsp;&nbsp;
                            </div>
                        </div>
                        <div class="tab">
                            <div id="tab0"></div>
                            <div id="tab1" class="form-group" style="display:none;">
                                <label>分组：</label>
                                <select name="group_id" class="form-control select2 select2-hidden-accessible" style="width: 100%;" tabindex="-1" aria-hidden="true">
                                    <option value="">无</option>
                                    <volist name="group" id="vo">
                                        <option value="{$vo.id}" <eq name="info.pid" value="$vo.id" > selected </eq> >{$vo.name}</option>
                                    </volist>
                                </select>
                            </div>
                            <div id="tab2" style="display:none;">
                                <button type="button" class="btn btn-success" onclick="OpenFrame('{:U("Wechat/SelectUser")}');">选择用户</button> <label>[单击删除]</label>
                                <div id="user-list">
                                </div>
                            </div>
                        </div>
                        <br>
                        <include file="Public/InputReply" />
                    </div>
                    <!-- /.box-body -->
                    <div class="box-footer">
                        <button type="button" class="btn btn-primary" onclick="Preview()">预览</button>
                        <button type="submit" class="btn btn-primary" onclick="SubmitMass(1);return false;">提交</button>
                    </div>
                </div>
            </form>
        </div>
    </section>
    <!-- /.content -->

    <div class="modal fade" id="WxName" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                    <h4 class="modal-title">填写预览者微信号或昵称</h4>
                </div>
                <div class="modal-body">
                    <form class="form-inline" action="{:U('Wechat/GroupUser')}" style="width:100%;">
                        <input type="text" name="wxname" class="form-control" style="width:78%;" />
                        <button type="submit" style="width:18%;" class="btn btn-success" onclick="SubmitMass(0);return false;" >提交</button>
                    </form>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div>
</block>
<block name="script">
    <style>
        #user-list { margin-top:10px; }
        #user-list label { margin-top:5px;margin-left:5px; }
    </style>
    <script>
        var mass_type = 1;
        $('.sub_tab li').click(function(){
            var arr = $(this).children().eq(0).attr('href').split('-')
            mass_type = arr[1];
        })

        $('input').on('ifChecked', function(event){
            var val = $(this).val();
            $('#tab'+val).show().siblings().hide();
        });

        function Preview(){
            $('#WxName').modal('show')
        }

        $(document).on('click','#user-list label',function(){
            $(this).remove();
        })

        function SubmitMass(type){
            var data = $('#form').serialize();
            if(!type){
                $('#WxName').modal('hide')
                var wxname = $('input[name=wxname]').val();
                data = data+ '' +  '&wxname='+wxname + '&preview=1' ;
            }
            data = data + '&mass_type='+ mass_type;

            $.ajax({
                url: '',
                type: 'post',
                data: data,
                beforeSend: loading(),
                success: function (data) {
                    if( data!='' && data.status == 1 ){
                        layer.msg(data.info, {
                            icon: 1,
                            time : 2000
                        }, function(){
                            if(data.url){
                                window.location.href = data.url;
                            }else {
                                window.location.reload();
                            }
                        });
                    }else if ( data!='' && data.status == 0) {
                        layer.msg(data.info, {icon: 0});
                    }else{
                        if(data){
                            layer.msg(data, {icon: 7});
                        }else{
                            layer.msg('系统出错！请稍后再试', {icon: 7});
                        }
                    }
                    loaded();
                },
                error:function(){
                    loaded();
                    layer.msg('系统异常！请稍后再试', {icon: 7});
                }
            })
        }
    </script>
</block>