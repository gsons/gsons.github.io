<extend name="Tpl:Base" />
<block name="body">
    <!-- Main content -->
    <section class="content">
        <form action="" id="form">
            <div class="box">
                <div class="box-body no-padding category-tree">
                    <ul>
                        <li class="theader">
                            <div class="slider">
                                收缩
                            </div>
                            <div class="sort">
                                排序
                            </div>
                            <div class="status">
                                状态
                            </div>
                            <div class="name">
                                名称
                            </div>
                            <div class="clear"></div>
                        </li>
                        {$tree}
                    </ul>
                </div><!-- /.box-body -->
                <div class="box-footer">
                    <eq name="copy" value="1">
                        <button type="button" class="btn btn-primary" data-form="form" onclick="copyArticle()">提交</button>
                        <else />
                        <button type="button" class="btn btn-primary" data-form="form" onclick="returnType()">提交</button>
                    </eq>
                </div>
            </div>
        </form>
    </section><!-- /.content -->
</block>
<block name="script">
    <style>
        .sort { display:none; }
        .category-tree ul li div.action { height:24px; }
        .icheckbox_square-blue { margin:0; }
    </style>
    <script>
        $.each($('.category-tree ul li .slider.fa'),function(){
            if( !$(this).parent().next().hasClass('level') ){
                $(this).removeClass('fa fa-fw fa-minus-square-o fa-plus-square-o')
            }
        })
        $('.category-tree ul li .slider.fa').click(function(){
            if( $(this).parent().next().hasClass('level') ){
                $(this).parent().next().slideToggle();
                $(this).toggleClass('fa-plus-square-o')
            }
        })
        $.each($('.level'),function(){
            $(this).children().last().find('em').addClass('last')
        })
        $.each($('.level'),function(){
            $(this).prev().find('.icheckbox_square-blue').remove();
        })

        function returnType(){
            var category = new Array();
            $.each( $('input[type=checkbox]:checked') ,function(){
                var _category = {
                    id : $(this).val(),
                    name : $(this).attr('data-name')
                };
                category.push(_category)
            })
            var exist = new Array();
            $.each($('.type-queue label input',parent.document), function(){
                exist.push($(this).val())
            })
            for(var p in category){
                for(var i in exist){
                    if( exist[i] == category[p].id){
                        category[p].disabled = 1;
                        break;
                    }
                    category[p].disabled = 0;
                }
            }
            for(var i in category){
                if( !category[i].disabled ) {
                    var label = '<label class="type-label" style="cursor:pointer;"><span>' + category[i].name + '</span><input type="checkbox" name="ext_type_id[]" value="' + category[i].id + '" style="display:none" checked ></label>&nbsp;';
                    $('.type-queue', parent.document).append(label);
                }
            }
            var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
            parent.layer.close(index);
        }

        function copyArticle(){
            loading();
            $.ajax({
                url: '',
                data: $('#form',parent.document).serialize()+'&'+$('#form').serialize(),
                type: 'post',
                success: function(data){
                    layer.msg(data.info, {
                        icon: data.status
                    }, function(){
                        var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                        parent.layer.close(index);
                    });
                },
                complete: loaded
            })
        }
    </script>
</block>