<extend name="Tpl:Base" />
<block name="body">
    <!-- Main content -->
    <section class="content">
        <div class="box">
            <div class="box-header">
                <h3 class="box-title iframe-title">分类管理</h3>
                <div class="btn-toolbar">
                    <a class="btn btn-info" href="{:U('TypeEdit',array('special'=>$special_id))}">新增</a>
                </div>
            </div><!-- /.box-header -->
            <div class="box-body no-padding category-tree">
                <form action="" id="form">
                    <ul>
                        <li class="theader">
                            <div class="slider">
                                收缩
                            </div>
                            <div class="sort">
                                排序
                            </div>
                            <div class="status">
                                状态
                            </div>
                            <div class="name">
                                名称
                            </div>
                            <div class="clear"></div>
                        </li>
                        {$tree}
                    </ul>
                </form>
            </div><!-- /.box-body -->
        </div>
    </section><!-- /.content -->
</block>
<block name="script">
    <style>
        i { font-style:normal; }
    </style>
    <script src="__PUBLIC__/AdminLTE/js/jquery.cookie.js"></script>
    <script>
        var split = $.cookie('split');
        if( split != '' && split ){
            split = JSON.parse(split);
            for(var i in split){
                $.each( $('.level') , function(key){
                    if( key == split[i] ) {
                        $(this).addClass('split').show();
                    }
                })
            }
        }
        $.each($('.category-tree ul li .slider.fa'),function(){
            if( !$(this).parent().next().hasClass('level') ){
                $(this).removeClass('fa fa-fw fa-minus-square-o fa-plus-square-o')
            }
        })
        $('.category-tree ul li .slider.fa').click(function(){
            if( $(this).parent().next().hasClass('level') ){
                $(this).parent().next().slideToggle().toggleClass('split');
                $(this).toggleClass('fa-plus-square-o')
            }

            var split = new Array();
            $.each( $('.level') , function(key){
                if( $(this).hasClass('split') ) {
                    split.unshift(key);
                }
            })
            $.cookie('split', JSON.stringify(split) ,{ path:'/' });
        })
        $.each($('.level'),function(){
            $(this).children().last().find('em').addClass('last')
        })
        $.each($('.level'),function(){
            $(this).prev().find('.navigation').remove();
        })

        var ids = new Array();
        var pos = new Array();
        $.each($('.count'),function(key){
            var id = $(this).parent().parent().parent().parent().attr('data-id')
            ids.unshift(id);
            pos.unshift(key);
        })
        $.ajax({
            url:'',
            data: { ids:ids,key:pos },
            type: 'post',
            dataType: 'json',
            success: function(data){
                for(var i in data){
                    $('.count').eq(data[i].key).html('('+data[i].count+')');
                    if( data[i].count == '0' ){
                        $('.count').eq(data[i].key).parent().addClass('text-danger');
                    }
                }
            }
        })

        var sort = '';
        $('.sort input').focus(function(){
            sort = $(this).val();
        })
        $('.sort input').blur(function(){
            if( sort == $(this).val() ){
                return;
            }
            loading();
            $.ajax({
                url:'{:U("Type/sort")}',
                data: { id:$(this).attr('id') ,sort:$(this).val() },
                type: 'post',
                dataType: 'json',
                success: function(data){
                    if( data.status == '1' ){
                        window.location.reload()
                    }else{
                        layer.msg('修改失败');
                    }
                },
                complete : loaded
            })
        })
    </script>
</block>