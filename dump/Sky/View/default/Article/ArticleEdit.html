<extend name="Tpl:Base"/>
<block name="body">
    <!-- Main content -->
    <section class="content">
        <a href="#" class="ion-reply history-back" onclick="history.back(1)">&nbsp;返回</a>
        <div class="nav-tabs-custom">
            <form action="" id="edit">
                <div class="box box-success">
                    <div class="box-header with-border">
                        <h3 class="box-title">文章增加/修改</h3>
                    </div>
                    <div class="box-body">
                        <div class="form-group">
                            <label><span class="text-red">*</span> 标题：</label>
                            <input type="text" class="form-control" placeholder="标题" name="title" value="{$info.title}">
                        </div>
                        <br>

                        <div class="form-group">
                            <label><span class="text-red">*</span> 文章分类： <span id="position" title="{$info.special_id|get_field='special','title'}{:substr(get_nav($info['type_id'],false),1)}">{$info.special_id|get_field='special','title'}{:substr(get_nav($info['type_id'],false),1)}</span></label>
                            <select name="type_id" id="type" class="form-control select2 select2-hidden-accessible"
                                    style="width: 100%;" tabindex="-1" aria-hidden="true">
                                <?php if(count($type) > 1):?><option value="">请选择文章分类</option><?php endif;?>
                                <volist name="type" id="vo">
                                    <option value="{$vo.id}"
                                    <eq name="info.type_id" value="$vo.id"> selected</eq>
                                    >{$vo.name}</option>
                                </volist>
                            </select>
                        </div>
                        <div class="box complicate">
                            <div class="box-header with-border">
                                多栏目发布 <input type="checkbox" name="complicate" value="1" />
                            </div>
                            <div class="box-body" style="display:none;">
                                <div class="form-group">
                                    <label>分类[双击即可删除]：</label>
                                    <a class="btn btn-info" data-form="form" onclick="OpenFrame('{:U("Type/Copy")}','多栏目发布','700px','600px')" >选择</a>
                                    <div class="type-queue">
                                        <br />
                                    </div>
                                </div>
                            </div>
                        </div>
                        <br>

                        <div class="form-group">
                            <label><span class="text-red">*</span> 作者：</label>
                            <select name="group_id" class="form-control select2 select2-hidden-accessible"
                                    style="width: 100%;" tabindex="-1" aria-hidden="true">

                                <?php if(count($group) > 1):?><option value="">请选择部门</option><?php endif;?>
                                <volist name="group" id="vo">
                                    <option value="{$vo.id}"
                                    <eq name="info.group_id" value="$vo.id"> selected</eq>
                                    >{$vo.title}</option>
                                </volist>
                            </select>
                        </div>
                        <br>

                        <div class="form-group">
                            <label><span class="text-red">*</span> 来源：</label>
                            <input type="text" class="form-control" placeholder="来源" name="source"
                                   value="{$info.source|default=广东郁南}">
                        </div>
                        <br>

                        <div class="form-group">
                            <label>封面图片：(600px * 400px)<button type="button" class="btn btn-primary" onclick="$('#queue img').remove();$('input[name=src]').val('')" >清空</button></label>
                            <input type="file" name="pic" id="pic_upload"/>
                            <div id="queue">
                                <notempty name="info.src">
                                    <img style="max-width:100%;" src="__UPLOAD__/{$info.src}" alt=""/> <input type="hidden" name="src" value="{$info.src}"/>
                                </notempty>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>视频（100M以内）(允许格式：flv,mp4）：</label>
                            <div id="uploader" class="wu-example">
                                <!--用来存放文件信息-->
                                <div id="thelist" class="uploader-list"></div>
                                <div class="btns">
                                    <div id="picker">选择文件</div>
                                </div>
                            </div>
                            <PHP>
                                $video = unserialize(htmlspecialchars_decode($info['video']));
                            </PHP>
                            <input type="hidden" class="form-control" name="video_src" value="{$video.src}" readonly >
                            <input type="text" class="form-control" style="margin-top:5px;" name="video_name" value="{$video.name}" />
                        </div>

                        <!--<div class="form-group">
                            <label>是否推荐：</label>
                            <label class="checkbox-inline">
                                <input type="radio" name="recommend" value="0" <neq name="info.recommend" value="1">checked</neq>  /> 否
                            </label>
                            <label class="checkbox-inline">
                                <input type="radio" name="recommend" value="1" <eq name="info.recommend" value="1">checked</eq> /> 是 &nbsp;
                            </label>
                        </div>
                        <br>-->

                        <div class="form-group">
                            <label>点击数：</label>
                            <input type="text" class="form-control" placeholder="点击数" name="click"  value="{$info.click}">
                        </div>
                        <br>

                        <div class="form-group">
                            <label><span class="text-red">*</span> 内容描述：</label>
                            <input type="textbox" class="form-control" placeholder="请输入内容简短描述" name="description" value="{$info.description}">
                        </div>
                        <br>

                        <?php /* ?>
                        <div class="form-group">
                            <label>排序：</label>
                            <input type="text" class="form-control" placeholder="排序" name="sort"
                                   value="{$info.sort|default=50}">
                        </div>
                        <br>
                        <?php */ ?>

                        <div class="form-group">
                            <label><span class="text-red">*</span> 详细内容：</label>
                            <script name="content" id="details" type="text/plain" style="height:300px;">
                                {$info.content|htmlspecialchars_decode|makeImgSrc}
                            </script>
                        </div>
                        <br>

                        <div class="form-group">
                            <label>发布时间</label>
                            <input type="text" class="form-control datetime" name="create_date" value="{: date('Y-m-d H:i:s',empty($info['create_date']) ? NOW_TIME : $info['create_date'])}">
                        </div>
                        <br>

                        <div class="form-group">
                            <label>状态：</label>
                            <label class="checkbox-inline">
                                <input type="radio" name="status" value="1" <neq name="info.status" value="0">checked</neq>  /> 发布
                            </label>
                            <label class="checkbox-inline">
                                <input type="radio" name="status" value="0" <eq name="info.status" value="0">checked</eq> /> 草稿 &nbsp;
                            </label>
                        </div>
                        <br>

                    </div>
                    <!-- /.box-body -->
                    <div class="box-footer">
                        <input type="hidden" name="id" value="{:I('get.id')}" />
                        <button type="submit" class="btn btn-primary ajax-submit ajax-post" data-form="edit">提交</button>
                        <egt name="info.status" value="0">
                            <button type="button" class="btn btn-warning"  data-href="{:modelUrl(U('Article/Details',array('id'=>$info['id'])),'index')}" onclick="window.open($(this).attr('data-href'))">预览</button>
                        </egt>
                    </div>
                </div>
            </form>

        </div>
<?php if($info['type_id'] == 2104 ):?>
    <div class="box">
            <div class="box-header">
                <h3 class="box-title iframe-title">评论</h3>
                <div class="btn-toolbar">
                        <a class="btn btn-danger ajax-submit ajax-post ajax-del" data-form="form" data-href="{:U('del')}">删除</a>
                    </div>
                <form action="" method="get" id="search_form">
                    <div class="search">
                    <?php /* ?>
                        <select name="type" class="form-control select2 select2-hidden-accessible" style="width: 100%;" tabindex="-1" aria-hidden="true">
                            <option value="">请选择</option>
                        </select>
                    <?php */ ?>
                        <input type="text" name="keyword" class="form-control" value="{:I('get.keyword')}">
                        <input type="submit" value="搜索" class="btn btn-info">
                    </div>
                </form>
            </div><!-- /.box-header -->
            <div class="box-body no-padding">
            <form action="" method="post" id="form">
                <table class="table table-striped">
                    <tbody>
                    <tr>
                        <th><input type="checkbox" data-check="check-all" data-name="ids[]"/><th  style="width: 100px;">编号</th><th>操作</th><th>评论内容</th><th>用户名</th><th>状态</th><th>评论日期</th><th>IP</th>
                    </tr>
                    <volist name="list" id="vo">
                        <tr>
                        <td><input type="checkbox" name="ids[]" value="{$vo.id}"/></td>
                            <td width="5%">{$vo.id}</td>
                            <td width="10%">
                                <!--<a href="{:U('Article/ArticleDetail',array('id'=>$vo['id']))}">查看</a>-->
                            <a class="ajax-submit ajax-get ajax-del" data-href="{:U('comment',array('id'=>$vo['id'],'status'=>($vo['status']==1?0:1)))}">{:$vo['status'] == 1 ? '取消审核' : '通过审核'}</a>
                            </td>
                            <td width="" title="{$vo.comment_content}">{$vo.comment_content|msubstr=0,30}</td>
                            <td width="10%" title="{$vo.name}">{$vo.name|msubstr=0,8}</td>
                            <td width="10%">{: $vo[status] ==  1? '已通过审核' : '未通过审核'}</td>
                            <td width="10%">{$vo.datetime|FormatDate}</td>
                            <td width="10%">{$vo.ip_address}</td>
                        </tr>
                    </volist>
                    </tbody></table>
                    </form>
            </div><!-- /.box-body -->
            <div class="box-footer">
                {$page}
            </div>
        </div>

<?php endif;?>
    </section>
    <!-- /.content -->

</block>
<block name="script">
    <script src="__PLUS__/ueditor/ueditor.config.js"></script>
    <script src="__PLUS__/ueditor/ueditor.all.min.js"></script>
    <script src="__PLUS__/ueditor/ueditor.parse.min.js"></script>
    <script>
        var ue = UE.getEditor('details', {
            toolbars: [[
                'source','|','undo', 'redo', '|',
                'bold', 'italic', 'underline', 'fontborder', 'strikethrough', 'superscript', 'subscript', 'removeformat', 'formatmatch', 'autotypeset', 'blockquote', 'pasteplain', '|', 'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'selectall', 'cleardoc', '|',
                'rowspacingtop', 'rowspacingbottom', 'lineheight', '|',
                'fontfamily', 'fontsize', '|',
                'directionalityltr', 'directionalityrtl', 'indent', '|',
                'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify', '|', 'touppercase', 'tolowercase', '|',
                'link', 'unlink', 'anchor', '|', 'imagenone', 'imageleft', 'imageright', 'imagecenter', '|',
                'attachment','simpleupload', 'insertimage', 'map', 'gmap', '|',
                'horizontal', 'date', 'time', 'spechars', 'wordimage', '|',
                'inserttable', 'deletetable', 'insertparagraphbeforetable', 'insertrow', 'deleterow', 'insertcol', 'deletecol', 'mergecells', 'mergeright', 'mergedown', 'splittocells', 'splittorows', 'splittocols', 'charts', '|',
                'drafts'
            ]]
        });
    </script>

    <script src="__PLUS__/uploadify/jquery.uploadify.min.js"></script>
    <link rel="stylesheet" href="__PLUS__/uploadify/uploadify.css"/>
    <script>
        var auid = '{:is_admin()}';
        $('#pic_upload').uploadify({
            'multi': true,
            'fileTypeExts': '*.gif; *.jpg; *.png',
            'formData': {'auid': auid},
            'buttonText': '上传',
            'swf': '__PLUS__/uploadify/uploadify.swf',
            'uploader': '{:U("Public/UploadFile",array("type"=>"image"))}',
            'height': 35,
            'width': 70,
            'onUploadSuccess': function (file, data, response) {
                var data = JSON.parse(data);
                if (data.status == '1') {
                    var picker = '<img style="max-width:100%;" src="__UPLOAD__/' + data.info.Filedata.savepath + '' + data.info.Filedata.savename + '" alt=""/> <input type="hidden" name="src" value="' + data.info.Filedata.savepath + '' + data.info.Filedata.savename + '" /> ';
                    $('#queue').html(picker);
                } else if (data.status == '0') {
                    layer.msg(data.info)
                } else {
                    layer.msg(data)
                }
            }
        });

        $('#video_upload').uploadify({
            'multi': true,
            'fileTypeExts': '*.mp4; *.wmv *.flv',
            'formData': {'auid': auid},
            'buttonText': '上传',
            'swf': '__PLUS__/uploadify/uploadify.swf',
            'uploader': '{:U("Public/UploadFile",array("type"=>"video"))}',
            'height': 35,
            'width': 70,
            'onUploadSuccess': function (file, data, response) {
                var data = JSON.parse(data);
                if (data.status == '1') {
                    var src = data.info.Filedata.savepath + '' + data.info.Filedata.savename;
                    $('input[name=video_src]').val(src);
                    $('input[name=video_name]').val(data.info.Filedata.name);
                } else if (data.status == '0') {
                    layer.msg(data.info)
                } else {
                    layer.msg(data)
                }
            }
        });

        $('.complicate .iCheck-helper').click(function(){
            $('.icheckbox_square-blue').hasClass('checked') ? $('.complicate .box-body').show():$('.complicate .box-body').hide();
        })

        $(document).on('dblclick','.type-label',function(){
            $(this).remove();
        })
    </script>

    <!--引入CSS-->
    <link rel="stylesheet" type="text/css" href="__PLUS__/Webuploader/webuploader.css">
    <!--引入JS-->
    <script type="text/javascript" src="__PLUS__/Webuploader/webuploader.js"></script>
    <script>

        var state = 'pending',uploader;

        uploader = WebUploader.create({
            swf: '__PLUS__/Webuploader/js/Uploader.swf',
            server: '{:U("Public/UploadChunkFile",array("type"=>"video"))}',
            pick: '#picker',
            resize: false,
            chunked : true,
            threads: 1,
            chunkSize : 1242880,
            fileSizeLimit : 100242880,
            auto : true,
            accept : {
                title: '视频',
                extensions: 'mp4,flv'
            }
        });
        uploader.on( 'fileQueued', function( file ) {
            $('#thelist').append( '<div id="' + file.id + '" class="item">' +
            '<h4 class="info">' + file.name + '</h4>' +
            '<p class="state">等待上传...</p>' +
            '</div>' );
        });
        uploader.on( 'uploadProgress', function( file, percentage ) {
            var $li = $( '#'+file.id ),
                    $percent = $li.find('.progress .progress-bar');
            // 避免重复创建
            if ( !$percent.length ) {
                $percent = $('<div class="progress progress-striped active">' +
                '<div class="progress-bar" role="progressbar" style="width: 0%">' +
                '</div>' +
                '</div>').appendTo( $li ).find('.progress-bar');
            }
            $li.find('p.state').text('上传中');
            $percent.css( 'width', percentage * 100 + '%' );
        });
        uploader.on( 'uploadSuccess', function( file , Response ) {
            if( Response.status == '1' ){
                $('input[name=video_src]').val(Response.info.combine)
                $('input[name=video_name]').val(Response.info.file.name)
                $('#thelist').html('');
                layer.msg('上传成功', {
                    icon: 1,
                    time: 2000 //2秒关闭（如果不配置，默认是3秒）
                });
            }else{
                layer.msg(Response.info);
            }
        });

        uploader.on( 'uploadError', function( file ) {
            $( '#'+file.id ).find('p.state').text('上传出错');
        });

        uploader.on( 'uploadComplete', function( file ) {
            $( '#'+file.id ).find('.progress').fadeOut();
        });

        uploader.on( 'error', function( error ) {
            if(error == "Q_EXCEED_SIZE_LIMIT"){
                layer.msg('视频文件超出大小')
            }else if( error == "Q_TYPE_DENIED" ){
                layer.msg('请上传MP4,FLV格式的视频文件')
            }
        });

    </script>

    <script>
        var ajaxRequest = '';
        var timeout = '';
        $("#type").select2({
            theme: "default type"
        })
        $(document).on('mouseover','.select2-container.select2-container--default.type li',(function(){
            var id = $(this).attr('id');
            id = id.split('-');
            id = id[id.length-1];
            timeout = setTimeout(function(){
                ajaxRequest = $.ajax({
                    url: '?id=&type_id='+id,
                    dataType: 'json',
                    beforeSend: function(){
                        if(ajaxRequest != '') {
                            ajaxRequest.abort();
                        }
                        var loading = '<i class="fa fa-refresh fa-spin"></i>';
                        $('#position').html(loading);
                    },
                    success: function(data){
                        $('#position').html(data.msg);
                    }
                })
            },30)
        }))
        $(document).on('click','.select2-container.select2-container--default.type li',(function(){
            $('#position').attr('title',$('#position').html())
        }))
        $(document).on('mouseleave','.select2-dropdown',(function(){
            clearTimeout(timeout);
            if(ajaxRequest != '') {
                ajaxRequest.abort();
            }
            var title = $('#position').prop('title');
            $('#position').html( title )
        }))
    </script>
</block>